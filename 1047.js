"use strict";(self["webpackChunkpdd"]=self["webpackChunkpdd"]||[]).push([[1047],{11047:function(e,t,a){a.r(t),a.d(t,{default:function(){return p}});var l=function(){var e=this,t=e._self._c;return t("ai-list",{directives:[{name:"loading",rawName:"v-loading",value:e.isLoading,expression:"isLoading"}],staticClass:"list",attrs:{"element-loading-text":"拼命加载中","element-loading-spinner":"el-icon-loading"}},[t("ai-title",{attrs:{slot:"title",title:"数据同步(TEMU)",isShowBottomBorder:""},slot:"title"}),t("template",{slot:"content"},[t("el-card",{staticClass:"box-card"},[t("div",{staticClass:"clearfix",attrs:{slot:"header"},slot:"header"},[t("span",[e._v("店铺列表")])]),t("div",[t("el-checkbox",{attrs:{indeterminate:e.isMallIndeterminate},on:{change:e.handleCheckAllMallChange},model:{value:e.checkAllMall,callback:function(t){e.checkAllMall=t},expression:"checkAllMall"}},[e._v("全选")]),t("div",{staticStyle:{margin:"15px 0"}}),t("el-checkbox-group",{on:{change:e.handleCheckedMallChange},model:{value:e.checkMallList,callback:function(t){e.checkMallList=t},expression:"checkMallList"}},e._l(e.$store.state.mallList,(function(a){return t("el-checkbox",{key:a.mallId,staticStyle:{width:"300px","margin-right":"0px"},attrs:{label:a.mallId}},[e._v(e._s(a.isSemiManagedMall?a.mallName+"(半托管)":a.mallName))])})),1)],1)]),t("el-card",{staticClass:"box-card",staticStyle:{"margin-top":"5px"}},[t("div",{staticClass:"clearfix",attrs:{slot:"header"},slot:"header"},[t("span",[e._v("同步操作")])]),t("div",[t("div",[t("label",{staticStyle:{width:"90px"}},[e._v("时间范围：")]),t("el-date-picker",{attrs:{type:"daterange","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"yyyy-MM-dd","value-format":"yyyy-MM-dd","picker-options":e.pickerOptions},model:{value:e.dateRange,callback:function(t){e.dateRange=t},expression:"dateRange"}})],1),t("br"),t("el-checkbox",{attrs:{indeterminate:e.isOptionIndeterminate},on:{change:e.handleCheckAllOptionChange},model:{value:e.checkAllOptions,callback:function(t){e.checkAllOptions=t},expression:"checkAllOptions"}},[e._v("全选")]),t("div",{staticStyle:{margin:"15px 0"}}),t("el-checkbox-group",{on:{change:e.handleCheckedOptionChange},model:{value:e.checkOptionList,callback:function(t){e.checkOptionList=t},expression:"checkOptionList"}},e._l(e.options,(function(a){return t("el-checkbox",{key:a.value,staticStyle:{width:"300px","margin-right":"0px"},attrs:{label:a.value}},[e._v(e._s(a.label))])})),1)],1)]),t("div",{staticStyle:{display:"grid","grid-template-columns":"1fr",gap:"16px","margin-top":"10px"}},[t("el-button",{class:"el-button el-button--primary",attrs:{type:"button"},on:{click:function(t){return e.sync()}}},[e._v("同步")])],1),t("el-card",{staticClass:"box-card",staticStyle:{"margin-top":"5px"}},[t("div",{staticClass:"clearfix",attrs:{slot:"header"},slot:"header"},[t("span",[e._v("日志输出")])]),t("div",{staticStyle:{height:"500px","background-color":"black","overflow-y":"scroll",border:"1px solid #000",padding:"5px",color:"white"},attrs:{id:"log-container"},domProps:{innerHTML:e._s(e.logsContent)}})])],1)],2)},s=[],i=(a(44114),a(98992),a(54520),a(3949),a(81454),a(8872),a(31052)),r=a(73236),c=a(31981),o={name:"SyncDataTemu",data(){return{isLoading:!1,categoryList:[],checkAllMall:!1,checkAllOptions:!1,checkMallList:[],checkOptionList:[],isMallIndeterminate:!1,isOptionIndeterminate:!1,mallList:[],currentIndex:0,pageSize:100,pageNo:1,syncProductData:[],deliveryOrderList:[],currentWaitDeliveryIndex:0,waitDeliveryData:[],options:[{label:"同步已上架商品列表",value:0},{label:"同步今日待收货发货单",value:1},{label:"同步今日销售数据",value:2},{label:"同步SKU历史销售数据",value:3}],dateRange:[new Date,new Date],pickerOptions:{disabledDate(e){return e.getTime()>Date.now()}},logsList:[],todaySaleDataList:[]}},created(){},computed:{logsContent(){return this.logsList.join("<br>")}},methods:{handleCheckAllMallChange(e){this.checkMallList=e?this.mallList.map((e=>e.mallId)):[],this.isMallIndeterminate=!1},handleCheckedMallChange(e){let t=e.length;this.checkAllMall=t===this.mallList.length,this.isMallIndeterminate=t>0&&t<this.mallList.length},handleCheckAllOptionChange(e){this.checkOptionList=e?this.options.map((e=>e.value)):[],this.isOptionIndeterminate=!1},handleCheckedOptionChange(e){let t=e.length;this.checkAllOptions=t===this.options.length,this.isOptionIndeterminate=t>0&&t<this.options.length},async sync(){if(0!=this.checkMallList.length)if(0!=this.checkOptionList.length){this.isLoading=!0;for(let e=0;e<this.checkOptionList.length;e++){if(0==this.checkOptionList[e])for(let e=0;e<this.checkMallList.length;e++){let t=this.$store.state.mallList.filter((t=>t.mallId==this.checkMallList[e])),a=t[0].mallName;this.syncProductData=[],this.pageNo=1,await this.syncProduct(this.checkMallList[e],a)}if(1==this.checkOptionList[e])for(let e=0;e<this.checkMallList.length;e++){let t=this.$store.state.mallList.filter((t=>t.mallId==this.checkMallList[e])),a=t[0].mallName;this.deliveryOrderList=[],this.pageNo=1,await this.syncDeliveryOrder(this.checkMallList[e],a)}if(2==this.checkOptionList[e])for(let e=0;e<this.checkMallList.length;e++){let t=this.$store.state.mallList.filter((t=>t.mallId==this.checkMallList[e])),a=t[0].mallName;this.todaySaleDataList=[],this.pageNo=1,await this.syncTodaySaleData(this.checkMallList[e],a)}}this.isLoading=!1}else i.Message.error("请选择要同步的操作");else i.Message.error("请选择要同步的店铺")},async syncProduct(e,t){let a=await(0,r.w4)({url:"bg-visage-mms/product/skc/pageQuery",anti:!0,needMallId:!0,mallId:e,data:{pageSize:this.pageSize,page:this.pageNo,skcSiteStatus:1}});1e6==a.errorCode?(a.result.pageItems.map((a=>{let l={mallId:e,mallName:t,productName:a.productName,spu:a.productId,skc:a.productSkcId,skcCode:a.extCode,createTime:(0,c.z)(a.createdAt)};a.productSkuSummaries.map((e=>{let t={...l,skuCode:e.extCode,sku:e.productSkuId,mainPic:e.thumbUrl,price:e.supplierPrice/100},a=e.productSkuSpecList.map((e=>e.specName));t.skuSpec=a.join(","),this.syncProductData.push(t)}))})),a.result.pageItems.length==this.pageSize?(this.pageNo++,await this.syncProduct(e,t)):this.$http.post("/api/stock/product/addBatch",this.syncProductData).then((e=>{0==e.code?this.logs(t,"已上架商品",0):this.logs(t,"已上架商品",1)}))):this.logs(t,"已上架商品",1)},async syncDeliveryOrder(e,t){let a=new Date;a.setHours(0,0,0,0);let l=a.getTime(),s=l+864e5-1e3,i=await(0,r.w4)({url:"bgSongbird-api/supplier/deliverGoods/management/pageQueryDeliveryBatch",anti:!0,needMallId:!0,mallId:e,data:{pageNo:this.pageNo,pageSize:this.pageSize,productLabelCodeStyle:0,onlyTaxWarehouseWaitApply:!1,deliverTimeFrom:l,deliverTimeTo:s,status:1}});1e6==i.errorCode?(i.result.list.map((a=>{let l={mallId:e,mallName:t,subWarehouseName:a.subWarehouseName,expressCompany:a.expressCompany,deliveryOrderSn:a.deliveryOrderSn};a.deliveryOrderList.map((e=>{let t={...l,productName:e.subPurchaseOrderBasicVO.productName,skc:e.productSkcId,skcCode:e.skcExtCode,isFirst:e.subPurchaseOrderBasicVO.isFirst?1:0,subPurchaseOrderSn:e.subPurchaseOrderSn,createTime:(0,c.z)(e.deliverTime)},a=e.packageDetailList.reduce(((e,{productSkuId:t,skuNum:a})=>(e[t]=(e[t]||0)+a,e)),{});Object.keys(a).forEach((e=>{this.deliveryOrderList.push({...t,sku:e,num:a[e]})}))}))})),i.result.list.length==this.pageSize?(this.pageNo++,await this.syncDeliveryOrder(e,t)):this.$http.post("/api/stock/orderInfo/addBatch",this.deliveryOrderList).then((e=>{0==e.code?0==e.data?this.logs(t,"今日待收货发货单",0):this.logs(t,"今日待收货发货单",2):this.logs(t,"今日待收货发货单",1)}))):this.logs(t,"今日待收货发货单",1)},async syncTodaySaleData(e,t){let a=await(0,r.w4)({url:"marvel-mms/cn/api/kiana/venom/sales/management/listWarehouse",needMallId:!0,mallId:e,data:{pageNo:this.pageNo,pageSize:this.pageSize,isLack:0,todaySaleVolumMin:1,priceAdjustRecentDays:7}});if(1e6==a.errorCode){for(let l=0;l<a.result.subOrderList.length;l++){let s=a.result.subOrderList[l];for(let a=0;a<s.skuQuantityDetailList.length;a++)this.todaySaleDataList.push({mallId:e,mallName:t,skc:s.productSkcId,sku:s.skuQuantityDetailList[a].productSkuId,num:s.skuQuantityDetailList[a].todaySaleVolume,price:s.skuQuantityDetailList[a].supplierPrice/100,saleDate:(0,c.Y)(new Date)})}if(this.pageSize==a.result.subOrderList.length)this.pageNo++,await this.syncTodaySaleData(e,t);else{let e=await this.$http.post("/api/stock/todaySale/addBatch",this.todaySaleDataList);0==e.code&&this.logs(t,"今日销售数据",0)}}},logs(e,t,a){0==a?this.logsList.unshift(`【${e}】${t}<b style='color: green'>同步成功</b>`):1==a?this.logsList.unshift(`【${e}】${t}<b style='color: red'>同步失败</b>`):2==a&&this.logsList.unshift(`【${e}】${t}<b style='color: yellow'>部分同步成功</b>`)}}},n=o,d=a(81656),h=(0,d.A)(n,l,s,!1,null,"4443253a",null),p=h.exports}}]);